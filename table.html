<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>熊が出るBMS難易度表</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="bmstable" content="./header.json">

  <link rel="stylesheet" href="style/style.css" type="text/css" media="screen,print">

  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
</head>

<body>
  <center>
    <strong><span style="font-size: 24pt;">熊が出るBMS難易度表[工事中：動かないかも] (読み込みに数秒かかります)</span></strong><br>
    <a href="index.html">TOP</a><br>
  </center>

  <div class="tableflame">
    <table align="center" cellspacing="1" cellpadding="2" border="0" bgcolor="#000000" id="table_int"></table>
  </div>

  <script>
  // メニュー切り替え
  function menu(tName) {
    const tMenu = document.getElementById(tName).style;
    tMenu.display = (tMenu.display === 'none') ? 'block' : 'none';
  }

  $(document).ready(function () {
    const headerPath = $("meta[name=bmstable]").attr("content");
    $.getJSON(headerPath, function (header) {
      $.getJSON(header.data_url, function (information) {
        if (header["level_order"]) {
          makeBMSTable(information, header.symbol, header["level_order"]);
        } else {
          makeBMSTable(information, header.symbol);
        }
      });
    });
  });

  // 難易度表生成
  function makeBMSTable(info, mark, order = null) {
    const obj = $("#table_int");
    obj.html("");

    $("<tr height='20' style='color:white;background-color:#666666'>" +
      "<td align='center'>LV</td><td align='center'>動画</td><td align='center'>譜面</td>" +
      "<td colspan='2' align='center'>beatoraja IR</td>" +
      "<td align='center'>タイトル</td><td align='center'>作者</td>" +
      "<td align='center'>差分</td><td align='center'>コメント</td>" +
    "</tr>").appendTo(obj);

    // ▼▼▼ ここからが変更点です (ソート処理) ▼▼▼
    // ソート処理を、一番シンプルなものに戻しました。
    if (order && order.length > 0) {
      const orderAry = order.map(o => o.toString());
      info.forEach(item => item._index = orderAry.indexOf(item.level.toString()));
      info.sort((a, b) => a._index - b._index || a.title.localeCompare(b.title));
      info.forEach(item => delete item._index);
    } else {
      // level_orderが無い場合は、数字・文字列の単純な昇順ソート
      info.sort((a, b) => {
        const aLv = a.level.toString(), bLv = b.level.toString();
        if (!isNaN(a.level) && !isNaN(b.level)) return a.level - b.level;
        if (aLv !== bLv) return aLv.localeCompare(bLv);
        return a.title.localeCompare(b.title);
      });
    }
    // ▲▲▲ ここまでが変更点です ▲▲▲


    // テーブル構築
    let currentLevel = "";
    let count = 0;
    let obj_sep = null;
    
    // 状態(state)に基づくテキストを定義
    const stateMap = {
      1: { text: "(新規追加)", color: "red" },
      2: { text: "(難易度変更)", color: "blue" },
      3: { text: "(評価・投票中)", color: "green" },
      4: { text: "(オススメ)", color: "gold" },
      5: { text: "(削除)", color: "gray" },
      6: { text: "(復活)", color: "orange" }
    };

    info.forEach((item, i) => {
      if (currentLevel !== item.level) {
        if (obj_sep) {
          obj_sep.html(`<td colspan='9' align='center'><b>${mark}${currentLevel} (${count}譜面)</b></td>`);
        }
        obj_sep = $(`<tr class='tr_separate' id='${mark}${item.level}'></tr>`);
        obj_sep.appendTo(obj);
        count = 0;
        currentLevel = item.level;
      }

      let trClass = "tr_normal";
      if (item.state && item.state != 0) trClass = `state${item.state}`;
      const row = $(`<tr class='${trClass}'></tr>`);

      $("<td width='6%'>" + mark + currentLevel + "</td>").appendTo(row);

      // 動画リンク
      let videoHTML = "";
      if (item.video1) {
        videoHTML = `<a href='https://www.nicovideo.jp/watch/sm${item.video1}' target='blank'><img src='style/nico.gif' border='0' alt='ニコ動'></a>`;
      } else if (item.video2) {
        videoHTML = `<a href='https://www.youtube.com/watch?v=${item.video2}' target='blank'><img src='style/youtube.gif' border='0' alt='YouTube'></a>`;
      } else if (item.video3) {
        videoHTML = `<a href='https://vimeo.com/${item.video3}' target='blank'><img src='style/vimeo.gif' border='0' alt='vimeo'></a>`;
      }
      $("<td width='1%' align='center'>" + (videoHTML || "") + "</td>").appendTo(row);

      // 譜面画像リンク
      $("<td width='1%' align='center'><a href='https://bms-score-viewer.pages.dev/view?md5=" + item.md5 + "' target='blank'>譜</a></td>").appendTo(row);

      // beatoraja IR系リンク
      $("<td width='1%' align='center'><a href='https://mocha-repository.info/song.php?sha256=" + item.sha256 + "' target='blank'><img src='style/mochair_logo.gif' border='0' alt='Mocha'></a></td>").appendTo(row);
      $("<td width='1%' align='center'><a href='https://www.gaftalk.com/minir/#/viewer/song/" + item.sha256 + "/0' target='blank'><img src='style/minir_logo.gif' border='0' alt='MinIR'></a></td>").appendTo(row);

      // stateに基づくHTMLを生成
      let stateHTML = "";
      const stateInfo = stateMap[item.state];
      
      if (stateInfo) {
        stateHTML = `<br><span style="color: ${stateInfo.color}; font-weight: bold; font-size: 0.9em;">${stateInfo.text}</span>`;
      }

      // タイトル (stateHTML を結合)
      $("<td width='20%'><a href='https://www.dream-pro.info/~lavalse/LR2IR/search.cgi?mode=ranking&bmsmd5=" + item.md5 + "' target='_blank'>" + item.title + "</a>" + stateHTML + "</td>").appendTo(row);
      
      
      // アーティスト
      let artistHTML = "";
      
      // 1. アーティスト名 (item.artist)
      if (item.artist) {
        artistHTML = item.artist;
      }
      
      // 2. パック名 (item.name_pack)
      if (item.name_pack) {
        artistHTML += `<br>(${item.name_pack})`;
      }
      
      // 3. 本体URL (item.url)
      if (item.url) {
        if (artistHTML !== "") {
           artistHTML += "<br>";
        }
        artistHTML += `[<a href='${item.url}' target='_blank'>本体URL</a>]`; 
      }
      
      $("<td width='20%'>" + artistHTML + "</td>").appendTo(row);


      // 差分
      let diffHTML = "";
      if (item.url_diff) {
        diffHTML = `<a href='${item.url_diff}' target='_blank'>[差分URL]</a>`;
      }
      $("<td width='15%'>" + (diffHTML || "") + "</td>").appendTo(row);
      

      // コメント
      $("<td width='25%'>" + (item.comment || "") + "</td>").appendTo(row);

      row.appendTo(obj);
      count++;
    });

    if (obj_sep) {
      obj_sep.html(`<td colspan='9' align='center'><b>${mark}${currentLevel} (${count}譜面)</b></td>`);
    }
  }
  </script>
</body>
</html>
