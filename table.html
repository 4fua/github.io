<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>熊が出るBMS難易度表</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="bmstable" content="./header.json">

  <!-- スタイル -->
  <link rel="stylesheet" href="style/style.css" type="text/css" media="screen,print">

  <!-- jQuery（CDN） -->
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
</head>

<body>
  <center>
    <strong><span style="font-size: 24pt;">熊が出るBMS難易度表</span></strong><br>
    <a href="index.html">TOP</a><br>
  </center>

  <div class="tableflame">
    <table align="center" cellspacing="1" cellpadding="2" border="0" bgcolor="#000000" id="table_int"></table>
  </div>

  <script>
  // メニュー切り替え
  function menu(tName) {
    const tMenu = document.getElementById(tName).style;
    tMenu.display = (tMenu.display === 'none') ? 'block' : 'none';
  }

  $(document).ready(function () {
    const headerPath = $("meta[name=bmstable]").attr("content");
    $.getJSON(headerPath, function (header) {
      $.getJSON(header.data_url, function (information) {
        if (header["level_order"]) {
          makeBMSTable(information, header.symbol, header["level_order"]);
        } else {
          makeBMSTable(information, header.symbol);
        }
      });
    });
  });

  // 難易度表生成
  function makeBMSTable(info, mark, order = null) {
    const obj = $("#table_int");
    obj.html("");

    $("<tr height='20' style='color:white;background-color:#666666'>" +
      "<td align='center'>LV</td><td align='center'>動画</td><td align='center'>譜面</td>" +
      "<td colspan='2' align='center'>beatoraja IR</td>" +
      "<td align='center'>タイトル</td><td align='center'>作者</td>" +
      "<td align='center'>差分</td><td align='center'>コメント</td>" +
    "</tr>").appendTo(obj);

    // ソート処理
    if (order && order.length > 0) {
      const orderAry = order.map(o => o.toString());
      info.forEach(item => item._index = orderAry.indexOf(item.level.toString()));
      info.sort((a, b) => a._index - b._index || a.title.localeCompare(b.title));
      info.forEach(item => delete item._index);
    } else {
      info.sort((a, b) => {
        const aLv = a.level.toString(), bLv = b.level.toString();
        if (!isNaN(a.level) && !isNaN(b.level)) return a.level - b.level;
        if (aLv !== bLv) return aLv.localeCompare(bLv);
        return a.title.localeCompare(b.title);
      });
    }

    // テーブル構築
    let currentLevel = "";
    let count = 0;
    let obj_sep = null;

    info.forEach((item, i) => {
      if (currentLevel !== item.level) {
        if (obj_sep) {
          obj_sep.html(`<td colspan='9' align='center'><b>${mark}${currentLevel} (${count}譜面)</b></td>`);
        }
        obj_sep = $(`<tr class='tr_separate' id='${mark}${item.level}'></tr>`);
        obj_sep.appendTo(obj);
        count = 0;
        currentLevel = item.level;
      }

      let trClass = "tr_normal";
      if (item.state) trClass = `state${item.state}`;
      const row = $(`<tr class='${trClass}'></tr>`);

      $("<td width='6%'>" + mark + currentLevel + "</td>").appendTo(row);

      // 動画リンク
      let videoHTML = "";
      if (item.video1) {
        videoHTML = `<a href='https://www.nicovideo.jp/watch/sm${item.video1}' target='_blank'><img src='style/nico.gif' border='0' alt='ニコ動'></a>`;
      } else if (item.video2) {
        videoHTML = `<a href='https://www.youtube.com/watch?v=${item.video2}' target='_blank'><img src='style/youtube.gif' border='0' alt='YouTube'></a>`;
      } else if (item.video3) {
        videoHTML = `<a href='https://vimeo.com/${item.video3}' target='_blank'><img src='style/vimeo.gif' border='0' alt='vimeo'></a>`;
      }
      $("<td width='1%' align='center'>" + (videoHTML || "") + "</td>").appendTo(row);

      // 譜面画像リンク
      $("<td width='1%' align='center'><a href='https://bms-score-viewer.pages.dev/view?md5=" + item.md5 + "' target='_blank'>譜</a></td>").appendTo(row);

      // beatoraja IR系リンク
      $("<td width='1%' align='center'><a href='https://mocha-repository.info/song.php?sha256=" + item.sha256 + "' target='_blank'><img src='style/mochair_logo.gif' border='0' alt='Mocha'></a></td>").appendTo(row);
      $("<td width='1%' align='center'><a href='https://www.gaftalk.com/minir/#/viewer/song/" + item.sha256 + "/0' target='_blank'><img src='style/minir_logo.gif' border='0' alt='MinIR'></a></td>").appendTo(row);

      // タイトル
      $("<td width='20%'><a href='https://www.dream-pro.info/~lavalse/LR2IR/search.cgi?mode=ranking&bmsmd5=" + item.md5 + "' target='_blank'>" + item.title + "</a></td>").appendTo(row);

      // アーティスト
      let artistHTML = "";
      if (item.url) {
        artistHTML = `<a href='${item.url}' target='_blank'>${item.artist || item.url}</a>`;
      } else if (item.artist) {
        artistHTML = item.artist;
      }
      if (item.url_pack) {
        artistHTML += `<br>(<a href='${item.url_pack}' target='_blank'>${item.name_pack || item.url_pack}</a>)`;
      } else if (item.name_pack) {
        artistHTML += `<br>(${item.name_pack})`;
      }
      $("<td width='20%'>" + artistHTML + "</td>").appendTo(row);

      // 差分
      let diffHTML = "";
      if (item.url_diff) {
        diffHTML = `<a href='${item.url_diff}' target='_blank'>${item.name_diff || item.url_diff}</a>`;
      } else if (item.name_diff) {
        diffHTML = item.name_diff;
      }
      $("<td width='15%'>" + (diffHTML || "") + "</td>").appendTo(row);

      // コメント
      $("<td width='25%'>" + (item.comment || "") + "</td>").appendTo(row);

      row.appendTo(obj);
      count++;
    });

    if (obj_sep) {
      obj_sep.html(`<td colspan='9' align='center'><b>${mark}${currentLevel} (${count}譜面)</b></td>`);
    }
  }
  </script>
</body>
</html>
